#!/usr/bin/env node

import { Server } from "@modelcontextprotocol/sdk/server/index.js";
<% if (transport === 'stdio') { %>
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
<% } else { %>
import { SSEServerTransport } from "@modelcontextprotocol/sdk/server/sse.js";
<% } %>
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";

const server = new Server(
  {
    name: "<%= name %>",
    version: "1.0.0",
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

// Define available tools
server.setRequestHandler(ListToolsRequestSchema, async () => ({
  tools: [
<% if (includeExampleTool) { %>
    {
      name: "example_tool",
      description: "An example tool that echoes the input",
      inputSchema: {
        type: "object",
        properties: {
          query: {
            type: "string",
            description: "The query to echo",
          },
        },
        required: ["query"],
      },
    },
<% } %>
<% tools.forEach(function(tool) { %>
    {
      name: "<%= tool.name %>",
      description: "<%= tool.description %>",
      inputSchema: {
        type: "object",
        properties: {
<% tool.parameters.forEach(function(param, index) { %>
          <%= param.name %>: {
            type: "<%= param.type %>",
            description: "<%= param.description %>",
          }<%= index < tool.parameters.length - 1 ? ',' : '' %>
<% }); %>
        },
        required: [<%- tool.parameters.filter(p => p.required).map(p => '"' + p.name + '"').join(', ') %>],
      },
    },
<% }); %>
  ],
}));

// Handle tool calls
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params;

<% if (includeExampleTool) { %>
  if (name === "example_tool") {
    const query = args?.query as string;
    return {
      content: [
        {
          type: "text",
          text: `Echo: ${query}`,
        },
      ],
    };
  }
<% } %>

<% tools.forEach(function(tool) { %>
  if (name === "<%= tool.name %>") {
    // TODO: Implement <%= tool.name %> logic
<% tool.parameters.forEach(function(param) { %>
    const <%= param.name %> = args?.<%= param.name %> as <%= param.type === 'number' ? 'number' : param.type === 'boolean' ? 'boolean' : 'string' %>;
<% }); %>

    return {
      content: [
        {
          type: "text",
          text: `<%= tool.name %> called with: ${JSON.stringify(args)}`,
        },
      ],
    };
  }
<% }); %>

  throw new Error(`Unknown tool: ${name}`);
});

// Start the server
async function main() {
<% if (transport === 'stdio') { %>
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error("<%= name %> MCP server running on stdio");
<% } else { %>
  const transport = new SSEServerTransport("/messages", response);
  await server.connect(transport);
  console.error("<%= name %> MCP server running on SSE");
<% } %>
}

main().catch((error) => {
  console.error("Fatal error:", error);
  process.exit(1);
});
